{% extends 'base.html' %}

{% block title %}NPS Query Builder{% endblock %}
{% block description %}Build and execute custom SQL queries to explore NPS fund data.{% endblock %}
{% block keywords %}NPS, NAV, SQL Query Builder, Pension Funds, India{% endblock %}
{% block og_title %}NPS Query Builder{% endblock %}
{% block og_description %}Execute custom SQL queries to fetch NPS fund data interactively.{% endblock %}
{% block og_url %}https://npsnav.in/query-builder{% endblock %}
{% block canonical %}https://npsnav.in/query-builder{% endblock %}

{% block content %}

<div class="query-container">
    <h2>Custom NPS Data Query Builder</h2>

    <div class="warning">
        <p><strong>Important:</strong> This tool runs on Cloudflare's FREE tier. Please use responsibly. Abuse may cause the database to hit its limits, resulting in errors or empty responses. If you encounter issues, try again after the limit resets.</p>
    </div>

    <div class="example-tabs">
        <button class="tab active" data-tab="basic-examples">Basic</button>
        <button class="tab" data-tab="date-filters">Date Filters</button>
        <button class="tab" data-tab="advanced-examples">Advanced</button>
        <button class="tab" data-tab="calculations">Calculations</button>
    </div>
    
    <div class="tab-content active" id="basic-examples">
        <code>SELECT * FROM fund_daily_values WHERE fund_id = 'SM001001' ORDER BY date DESC LIMIT 10</code>
    </div>
    
    <div class="tab-content" id="date-filters">
        <code>SELECT date, nav FROM fund_daily_values WHERE fund_id = 'SM002002' AND date BETWEEN '2024-01-01' AND '2024-06-30'</code>
    </div>
    
    <div class="tab-content" id="advanced-examples">
        <code>
    SELECT 
        f.fund_id,
        f.date,
        f.nav as fund_nav,
        n.nav as nifty_nav
    FROM fund_daily_values f
    LEFT JOIN nifty_daily_values n ON f.date = n.date
    WHERE f.fund_id = 'SM001001'
    AND f.date >= '2024-01-01'
    ORDER BY f.date DESC
    LIMIT 10
        </code>
    </div>
    
    <div class="tab-content" id="calculations">
        <code>
    SELECT 
        f.fund_id,
        f.date,
        f.nav as fund_nav,
        n.nav as nifty_nav,
        ROUND(((f.nav - LAG(f.nav) OVER (ORDER BY f.date)) / LAG(f.nav) OVER (ORDER BY f.date) * 100), 2) as daily_fund_return_pct,
        ROUND(((n.nav - LAG(n.nav) OVER (ORDER BY f.date)) / LAG(n.nav) OVER (ORDER BY f.date) * 100), 2) as daily_nifty_return_pct
    FROM fund_daily_values f
    LEFT JOIN nifty_daily_values n ON f.date = n.date
    WHERE f.fund_id = 'SM001001'
    AND f.date >= '2024-01-01'
    ORDER BY f.date DESC
    LIMIT 10
        </code>
        <br><br>
        <code>
    SELECT 
        f.date,
        f.nav as current_fund_nav,
        n.nav as current_nifty_nav,
        ROUND(((f.nav / MIN(f.nav) OVER (ORDER BY f.date ROWS BETWEEN 29 PRECEDING AND CURRENT ROW)) - 1) * 100, 2) as fund_30day_return_pct,
        ROUND(((n.nav / MIN(n.nav) OVER (ORDER BY f.date ROWS BETWEEN 29 PRECEDING AND CURRENT ROW)) - 1) * 100, 2) as nifty_30day_return_pct
    FROM fund_daily_values f
    LEFT JOIN nifty_daily_values n ON f.date = n.date
    WHERE f.fund_id = 'SM001001'
    AND f.date >= '2024-01-01'
    ORDER BY f.date DESC
    LIMIT 10
        </code>
    </div>
    <p><small>Click a query to use it.</small></p>

    
    

    

    <form id="query-form" method="POST" action="">
        <label for="query-input">Enter your SQL query below (Only SELECT queries are allowed):</label>
        <textarea id="query-input" name="query" rows="5">
    SELECT *
    FROM fund_daily_values
    WHERE fund_id = 'SM001001'
    AND date > '2024-12-05'
    LIMIT 10
        </textarea>
        <button type="submit" id="query-submit">Run Query</button>
    </form>
    

    <div id="query-results" style="display: none;">
        <div class="tabs-container">
            <div class="tabs">
                <button class="tab active" data-tab="table-view">Table</button>
                <button class="tab" data-tab="json-view">JSON</button>
            </div>
            <button id="download-csv" style="display: none;">Download as .csv</button>
        </div>
        <div id="spinner" style="display: none; text-align: center;">
            <img src="/assets/images/spinner.gif" alt="Loading..." style="width: 50px; height: 50px;">
            <p>Query is processing...</p>
        </div>
        <div class="tab-content" id="table-view" style="display: none;">
            <table id="results-table">
                <thead></thead>
                <tbody></tbody>
            </table>
        </div>
        <div class="tab-content" id="json-view" style="display: none;">
            <div class="json-header">
                <h3>JSON Results</h3>
                <button id="copy-json" style="display: none;">Copy JSON</button>
            </div>
            <pre id="results-json">JSON results will appear here...</pre>
        </div>
    </div>
    
    
</div>

{% endblock %}



{% block scripts %}
     <script src="/assets/js/query.js"></script>
{% endblock %}

