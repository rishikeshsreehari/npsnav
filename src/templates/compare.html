{% extends "base.html" %}

{% block title %}Compare Pension Funds | NPSNAV.in{% endblock %}

{% block content %}
  <div class="container mx-auto px-4 py-6">
    <h1 class="text-2xl font-semibold mb-4">Compare Pension Funds</h1>

    <form id="compare-form">
      <div class="overflow-x-auto bg-white rounded-lg shadow">
        <table class="min-w-full">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-4 py-2 text-left text-sm font-medium text-gray-700">Select</th>
              <th class="px-4 py-2 text-left text-sm font-medium text-gray-700">Scheme Name</th>
              <th class="px-4 py-2 text-left text-sm font-medium text-gray-700">PFM</th>
              <th class="px-4 py-2 text-left text-sm font-medium text-gray-700">NAV</th>
              <th class="px-4 py-2 text-left text-sm font-medium text-gray-700">1Y</th>
              <th class="px-4 py-2 text-left text-sm font-medium text-gray-700">3Y</th>
              <th class="px-4 py-2 text-left text-sm font-medium text-gray-700">5Y</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-200">
            {% for fund in funds %}
            <tr class="bg-white">
              <td class="px-4 py-2">
                <input type="checkbox" name="selected_funds" value="{{ fund['Scheme Code'] }}">
              </td>
              <td class="px-4 py-2">{{ fund['Scheme Name'] }}</td>
              <td class="px-4 py-2">{{ fund['PFM Name'] }}</td>
              <td class="px-4 py-2">{{ fund['NAV'] }}</td>
              <td class="px-4 py-2">{{ fund['1Y'] }}</td>
              <td class="px-4 py-2">{{ fund['3Y'] }}</td>
              <td class="px-4 py-2">{{ fund['5Y'] }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div class="mt-3 flex gap-2">
        <button type="submit" class="px-4 py-2 rounded bg-blue-600 text-white">Compare Selected Funds</button>
        <button type="button" id="clear-btn" class="px-4 py-2 rounded border">Clear</button>
      </div>
    </form>

    <section class="mt-6">
      <h2 class="text-xl font-semibold mb-2">Selected Funds Comparison</h2>
      <div id="comparison" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" aria-live="polite"></div>
    </section>
  </div>
{% endblock %}

{% block scripts %}
<script>
  const form = document.getElementById('compare-form');
  const comparisonEl = document.getElementById('comparison');
  const clearBtn = document.getElementById('clear-btn');

  // Embute os dados essenciais no build (sem fetch)
  const ALL_FUNDS = [
    {% for fund in funds %}
    {
      code: `{{ fund['Scheme Code'] }}`,
      name: `{{ fund['Scheme Name']|e }}`,
      pfm: `{{ fund['PFM Name']|e }}`,
      nav: `{{ fund['NAV'] }}`,
      y1: `{{ fund['1Y'] }}`,
      y3: `{{ fund['3Y'] }}`,
      y5: `{{ fund['5Y'] }}`
    }{% if not loop.last %},{% endif %}
    {% endfor %}
  ];

  form.addEventListener('submit', (e) => {
    e.preventDefault();
    const checked = Array.from(form.querySelectorAll('input[name="selected_funds"]:checked')).map(i => i.value);

    const details = ALL_FUNDS.filter(f => checked.includes(f.code));

    comparisonEl.innerHTML = details.length
      ? details.map(f => `
        <div class="bg-white rounded-lg shadow p-4">
          <div class="font-semibold mb-1">${f.name}</div>
          <div class="text-sm text-gray-600 mb-2">PFM: ${f.pfm} â€¢ Code: ${f.code}</div>
          <div class="flex justify-between py-1"><span>NAV</span><strong>${f.nav}</strong></div>
          <div class="flex justify-between py-1"><span>1Y</span><strong>${f.y1}</strong></div>
          <div class="flex justify-between py-1"><span>3Y</span><strong>${f.y3}</strong></div>
          <div class="flex justify-between py-1"><span>5Y</span><strong>${f.y5}</strong></div>
        </div>
      `).join('')
      : '<p class="text-gray-600">No funds selected.</p>';
  });

  clearBtn.addEventListener('click', () => {
    form.querySelectorAll('input[name="selected_funds"]').forEach(i => (i.checked = false));
    comparisonEl.innerHTML = '';
  });
</script>
{% endblock %}